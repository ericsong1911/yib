name: Build and Release

# This workflow runs automatically when a new tag starting with 'v' is pushed.
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # Job 1: Run tests and linters first to ensure code quality.
  test-and-lint:
    name: Test and Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.0'

      - name: Install Dependencies
        run: | 
          go mod tidy
          go mod download

      - name: Run Go Tests with FTS5
        run: go test -tags sqlite_fts5 -v ./...

      - name: Debug Environment
        run: |
          echo "Current directory: $(pwd)"
          echo "Go version: $(go version)"
          echo "Go env:"
          go env
          echo "Files in current directory:"
          ls -la
          echo "Go files:"
          find . -name "*.go" | head -10
          echo "Go modules:"
          go list -m all | head -5

      - name: Run Go Linter
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.62.2
          golangci-lint run --build-tags=sqlite_fts5
        continue-on-error: true

  # Job 2: Build the binaries for each platform after tests pass.
  build-binaries:
    name: Build Binaries
    needs: test-and-lint
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            binary_name: "yib"
          - os: linux
            arch: arm64
            binary_name: "yib"
          - os: windows
            arch: amd64
            binary_name: "yib.exe"
          - os: darwin # macOS
            arch: amd64
            binary_name: "yib"
          - os: darwin # macOS
            arch: arm64
            binary_name: "yib"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.0'

      - name: Extract Release Version from Tag
        run: echo "RELEASE_VERSION=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Build Go Binary with FTS5
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
        run: go build -tags "sqlite_fts5" -ldflags="-s -w" -o "release_package/${{ matrix.binary_name }}" .

      - name: Prepare Release Package
        run: |
          cp README.md release_package/
          cp LICENSE release_package/
          cp -r static release_package/
          cp -r templates release_package/
          if [ "${{ matrix.os }}" == "windows" ]; then
            cd release_package
            zip -r "../yib-${{ env.RELEASE_VERSION }}-${{ matrix.os }}-${{ matrix.arch }}.zip" .
          else
            cd release_package
            tar -czf "../yib-${{ env.RELEASE_VERSION }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz" .
          fi
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            yib-*.tar.gz
            yib-*.zip

  # Job 3: Create a single draft release and upload all the built assets.
  create-release:
    name: Create Draft Release
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code       
        uses: actions/checkout@v4 
        
      - name: Download all release assets
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          
      - name: Create Draft Release on GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "yib ${{ github.ref_name }}" \
            --draft \
            --generate-notes
          
      - name: Upload Release Assets to GitHub
        shell: bash
        run: |
          for dir in release-assets/*; do
            for file in "$dir"/*; do
              echo "Uploading $file..."
              gh release upload "${{ github.ref_name }}" "$file" --clobber
            done
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}